{% extends '../layout.html' %}
{% import '../macros/_answers.html' as answers_macro %}

{% block content %}
<!-- question -->

{% set questionTitleForSharing = question.title %}
{% if questionTitleForSharing.charAt(questionTitleForSharing.length - 1) !== '?' %}
    {% set questionTitleForSharing = questionTitleForSharing + '?' %}
{% endif %}

<script>
var questionTitle = '{{ questionTitleForSharing }}';
var refPathPrefix = '/r/';
var refUrlPrefix = window.location.origin + refPathPrefix;
var refUrlTwitter = refUrlPrefix + '{{ refcodes.twitter }}';
var refUrlFacebook = refUrlPrefix + '{{ refcodes.facebook }}';
var refUrlEmail = refUrlPrefix + '{{ refcodes.email }}';
var refUrlLink = refUrlPrefix + '{{ refcodes.link }}';

</script>

<script>
  window.fbAsyncInit = function() {
    FB.init({
      appId      : '1430472757228218',
      xfbml      : true,
      version    : 'v2.0'
    });
  };

  (function(d, s, id){
     var js, fjs = d.getElementsByTagName(s)[0];
     if (d.getElementById(id)) {return;}
     js = d.createElement(s); js.id = id;
     js.src = "//connect.facebook.net/en_US/sdk.js";
     fjs.parentNode.insertBefore(js, fjs);
   }(document, 'script', 'facebook-jssdk'));
</script>

<div class="page-header">
    <div class="row">
        <div class="col-sm-5">
            <div>
                <a href="/crisis/{{ crisis.id }}" title="Crisis">
                    <i class="fa fa-fw fa-dot-circle-o fa-breadcrumb"></i>{{ crisis.post.title }}
                </a>
                <span class="text-muted">/</span>
            </div>
            <h2 class="question-title">{{ question.title }}</h2>

                <p class="lead">
                    {{ question.text }}
                </p>
                
                {% if question.targetDateTimeOccurred %}
                <p class="metadata">
                    <i class="fa fa-clock-o fa-lg fa-fw"></i>
                    <span class="sr-only">Occurred:</span>
                    <span class="">{{ question.relativeTargetDateTimeOccurred }}</span>
                    <span class="text-muted">
                        &middot;
                    {{ question.targetDateTimeOccurred|date('D, d M Y H:i:s') }}
                     <abbr title="Coordinated Universal Time" class="initialism">
                         <a href="http://en.wikipedia.org/wiki/Coordinated_Universal_Time">UTC</a>
                     </abbr>
                     </span>
                </p>
                {% endif %}


                {% if question.targetLocality or question.targetLat %}
                <p class="metadata">
                    {% if question.targetLocality %}
                    <i class="fa fa-map-marker fa-lg fa-fw"></i><span class="sr-only">Locality:</span>&nbsp;<span id="question-locality">{{ question.post.targetLocality }}</span>
                    {% endif %}
                    
                    {% if question.targetLat and question.targetLong %}
                    <i class="fa fa-crosshairs fa-lg fa-fw"></i> <span class="sr-only">Lat Long:</span> <a href="geo:{{ question.post.targetLat }},{{ question.post.targetLong }}"><span id="question-target-lat">{{ question.post.targetLat }}</span>, <span id="question-target-long">{{ question.targetLong}}</span></a>
                    {% endif %}
                </p>
                {% endif %}

                <p class="metadata">
                    <i class="fa fa-bullhorn fa-lg fa-fw"></i>
                    <span class=""><abbr title="{{ question.date.toUTCString() }}">{{ question.relativeCreatedDate }}</abbr></span>
                    by {{ question.author }}
                </p>

                {% if question.tags and question.tags.length !== 0 %}
                <p class="metadata">
                    <i class="fa fa-tag fa-lg fa-fw"></i>
                        {% for tag in question.tags %}
                            <a href="/tag/{{ tag }}"><span class="label label-primary tag">{{ tag }}</span></a>
                        {% endfor %}
                </p>
                {% endif %}
                
                <div class="action-buttons">
                    <div class="row">
                    

                                                    
                    </div>
                
                    <!-- / action buttons row -->

                                                    
                </div>
                <!-- / action-buttons -->
                
            </div>
            
            
            <div class="col-sm-7 question-image-and-map-ctr">
                <div class="row">
                    {% if question.post.targetImage %}
                    <div class="col col-sm-6">
                        <img src="{{ question.post.targetImage }}" class="img-responsive">
                    </div>
                    <div class="col col-sm-6">
                    {% else %}
                    <div class="col col-sm-12">
                    {% endif %}
                        <div id="map" class="smallmap" style="height: 200px;"></div>
                        <!-- <img src="http://maps.googleapis.com/maps/api/staticmap?center=-15.800513,-47.91378&zoom=11&size=700x400&sensor=false" alt="map" class="img-responsive"> -->
                    </div>    
                </div>
                <!-- / .row -->
            </div>
            <!-- / .question-image-and-map-ctr -->
            
            
        </div>
        <!-- / question header row -->
        
        <!-- button-mark-true -->
        <div class="action-button-ctr btn-group">
            <button class="btn btn-success btn-large text-action-button {% if !user %} user-required-action{% endif %}" id="question-support" data-fragment="true"><i class="fa fa-check" id="icon-support"></i> <span class="hidden-xs">True because&hellip;</span> <span class="sr-only">True because&hellip;</span></button>
            {# <a href="#" class="btn btn-default action-button-count back-coloured">{{ question.supportedAnswerCount }}</a> #}
        </div>
        <!-- / button-mark-true -->
    
        <!-- button-mark-false -->
        <div class="action-button-ctr btn-group">
            <button class="btn btn-danger btn-large text-action-button {% if !user %} user-required-action{% endif %}" id="question-reject" data-fragment="false"><i class="fa fa-times" id="icon-reject"></i> <span class="hidden-xs">False because&hellip;</span> <span class="sr-only">False because&hellip;</span></button>
            {# <a href="#" class="btn btn-default action-button-count back-coloured">{{ question.rejectedAnswerCount }}</a> #}
        </div>
        <!-- / button-mark-false -->
    
        <!-- button-mark-important -->
        {% set questionMarkedImportant = question.post | isMarkedImportantBy(user) %}
        <div class="action-button-ctr btn-group">
            <button data-crisis-id="{{ crisis.id }}"
                    data-question-id="{{ question.id }}"
                    class="btn btn-default btn-large text-action-button btn_markImportant
                    {% if !user %} user-required-action{% endif %}
                    {% if questionMarkedImportant %}disabled{% endif %}"
                    title="Mark as important"><i class="fa fa-star">
                    </i> <span class="hidden-xs">Important</span> <span class="sr-only">Important</span>
            </button>
            <a href="#" class="btn btn-default action-button-count">{{ question.importanceCount }}</a>
        </div>
        <!-- / button-mark-important -->
        
        <!-- Twitter Tweet button -->
        <a href="https://twitter.com/share" class="twitter-share-button btn-group" id="tweet-button" data-url data-size="large">Tweet</a>
        <!-- / Twitter Tweet button -->
        
        <!-- Facebook Share button -->
        
        
        
        <!-- <div data-type="button_count" class="fb-share-button fb_iframe_widget" fb-xfbml-state="rendered" id="facebook-share-button"></div>-->
        <div id="fb-root"></div>
        <div class="action-button-ctr btn-group">
            <a class="btn btn-default btn-large text-action-button" id="facebook-share-button"><i class="fa fa-facebook-square fa-lg facebook-blue"></i> Share</a>
        </div>
        
        <!-- / Facebook Share button -->
        
        
        <!-- button-share-question-link -->
        <div class="action-button-ctr btn-group">
            <a class="btn btn-default btn-large text-action-button" id="button-share-question-link" data-toggle="modal" data-target="#modal-share-question-link"><i class="fa fa-link"></i> <span class="hidden-xs">Link</span></a>
        </div>
        <!-- / button-share-question-link -->
        
        <!-- button-email -->

        <div class="action-button-ctr btn-group">
            <a class="btn btn-default btn-large text-action-button" id="button-share-question-email" href="mailto:?subject={{ questionTitleForSharing }}"><i class="fa fa-envelope-o"></i> <span class="hidden-xs">Email</span></a>
        </div>
        <script>
        var buttonShareQuestionEmail = document.getElementById('button-share-question-email');
        var emailMessage = common.campaigner('email', '{{ questionTitleForSharing }}', refUrlEmail);
        buttonShareQuestionEmail.href = 'mailto:?subject=' + emailMessage.subject + '&body=' + emailMessage.body;
        </script>
        
        <!-- / button-email -->
                
        <!-- small buttons -->
        <div class="btn-group">
            <div class="additional-button-ctr">
                <a href="/crisis/{{ crisis.id }}/question/{{ question.id }}/edit" class="btn btn-default btn-sm"><i class="fa fa-edit"></i> <strong>Edit</strong></a>
            </div>
        </div>
        
        <div class="btn-group">
            <div class="additional-button-ctr">
                <button class="btn btn-default btn-sm" style="display: none;"><i class="fa fa-flag"></i> <strong>Flag</strong></button>
            </div>
        </div>
        <!-- / small buttons -->
        

        
        
        <!-- video -->
        {% if question.post.targetYoutubeVideoId %}
        <div class="video">
        <iframe width="323" height="200" src="//www.youtube.com/embed/{{ question.post.targetYoutubeVideoId }}?rel=0" frameborder="0" allowfullscreen></iframe>
        </div>
        {% endif %}
        <!-- / video -->
        
        
    </div>
<!-- / question -->

<!-- create evidence -->
{% include '../evidence/create.html' %}
<!-- / create evidence -->



<div class="row">
    <!-- <button class="btn btn-primary btn-large"><i class="fa fa-reply"></i> <strong>Verify</strong></button> -->
    
    
</div>

<h3>Responses</h3>
<div class="row question-answers">
    {{ answers_macro.answers_embeded(question.answers, crisis.id) }}
</div>


<div class="modal fade" id="modal-share-question-link" role="dialog">
  <div class="modal-dialog vertically-centred">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
        <h4 class="modal-title">Share link</h4>
      </div>
      <div class="modal-body">
        <span id="field-share-question-link"></span>
      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->



<script type="text/javascript">
// Support/Reject handle

// Hidden field of question type.
var questionType = document.getElementById('form-question-type');

// Display of question type
var labelQuestionType = document.getElementById('form-label-question-type');
var questionTypeClassName = labelQuestionType.className;

// Remove all children from an element
function resetElement(target) {
    while (target.firstChild) {
        labelQuestionType.removeChild(target.firstChild);
    }
}



function initActionButtons() {
    
    function displayQuestionTrueForm() {
        questionType.value = 'support';

        var supportIcon = document.createElement('i');
        supportIcon.className = 'fa fa-check';
        var content = document.createTextNode(' True because...');

        resetElement(labelQuestionType);
        labelQuestionType.insertBefore(content, labelQuestionType.nextSibling);
        labelQuestionType.insertBefore(supportIcon, content);
        labelQuestionType.className = questionTypeClassName + ' label-success';
        displayForm();
    }
    
    var update_markedImportant = function(crisis, element){
        element.next().html(crisis.importanceCount);
        element.addClass('active').addClass('disabled');
    }
    
    function displayQuestionFalseForm() {
        questionType.value = 'reject';

        var rejectIcon = document.createElement('i');
        rejectIcon.className = 'fa fa-times';
        var content = document.createTextNode(' False because...');

        resetElement(labelQuestionType);
        labelQuestionType.insertBefore(content, labelQuestionType.nextSibling);
        labelQuestionType.insertBefore(rejectIcon, content);

        labelQuestionType.className = questionTypeClassName + ' label-danger';
        displayForm();
    }
    
    if (window.location.search.indexOf('action=true') !== -1) {
        // Show the 'this is true' box.
        displayQuestionTrueForm();
    } else if (window.location.search.indexOf('action=false') !== -1) {
        // Show the 'this is false' box.
        displayQuestionFalseForm();
    }
    
    $('#question-support').click(function(){
        displayQuestionTrueForm();

    });
    $('#question-reject').click(function(){
        displayQuestionFalseForm();
    });
    
    
    
    
    $(".btn_markImportant").click(function(){
        var button = $(this);
        $.post('/crisis/'+button.attr('data-crisis-id')+'/question/'+button.attr('data-question-id')+'/markImportant',
                function(data){
                    var question = data;
                    update_markedImportant(question, button);
                }).fail(function(){
                    show_alert_message('danger', 5000, "Error", "There was an unknown error, please try again later. ");
                });
    });

    $('.btn_comment').click(function(){
        window.location = "/crisis/{{ crisis.id }}/question/{{ question.id }}/answer/"+$(this).data("answer-id")+"?action=comment";
    });

}

    $(function(){
        {% if user %}
            initActionButtons();
        {% else %}
            // $('.action-button-ctr .btn').tooltip();
        {% endif %}
    });


function displayForm() {
    // Display the form.
    var formCtr = document.getElementById('form-ctr')
    formCtr.style.display = 'block';
    var formTitle = document.getElementById('form-title');
    formTitle.focus();
    
    // Update chars left
    displayCharsLeft();
    
    // Scroll the top of the form into view.
    //formCtr.scrollIntoView();
    
}



</script>

<script>
window.twttr = (function (d, s, id) {
  var t, js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id; js.src= "https://platform.twitter.com/widgets.js";
  fjs.parentNode.insertBefore(js, fjs);
  return window.twttr || (t = { _e: [], ready: function (f) { t._e.push(f) } });
}(document, "script", "twitter-wjs"));

var tweetButton = document.getElementById('tweet-button');

var twitterCampaigner = common.campaigner('twitter');

tweetButton.dataset.url = refUrlTwitter;
tweetButton.dataset.counturl = window.location.origin + '{{ path }}';
tweetButton.dataset.text = questionTitle;
tweetButton.dataset.hashtags = twitterCampaigner.hashtags;

var facebookShareButton = document.getElementById('facebook-share-button');
facebookShareButton.dataset.href = refUrlFacebook;
facebookShareButton.dataset.type = 'button';

var emailButton = document.getElementById('button-share-question-email');

var linkButton = document.getElementById('button-share-question-link');


function intent (medium, intentEvent) {
  
  var refUrl = refUrlLink;
    
  if (medium === 'twitter') {
      console.log('twitter');
      refUrl = refUrlTwitter;
  } else if (medium === 'facebook') {
      console.log('facebook');
      refUrl = refUrlFacebook;
  } else if (medium === 'email') {
      console.log('email');
      refUrl = refUrlEmail;
  } else {
    console.log('link');
  }
  
  $.ajax({
      type: 'POST',
      url: refUrl,
      data: {
          destinationPath: '{{ path }}',
          medium: medium
      }
  });
}

// Wait for the asynchronous resources to load
twttr.ready(function (twttr) {
  // Now bind our custom intent events
  twttr.events.bind('click', function(intentEvent) {
      intent('twitter', intentEvent);
  });
});

facebookShareButton.addEventListener('click', function(e) {
    intent('facebook');
    FB.ui({
      method: 'feed',
      href: refUrlFacebook,
    }, function(response){
        
    });
});

emailButton.addEventListener('click', function(e) {
    intent('email');
});

linkButton.addEventListener('click', function(e) {
    // TODO: do input for everything other than xs devices.
    var shareQuestionLinkHtml = '<span class="hidden-xs">' + refUrlLink + '</span><span class="visible-xs">Hold to copy</span>';
    
    document.getElementById('field-share-question-link').innerHTML = refUrlLink;
    intent('link');
});




</script>

<script src="http://openlayers.org/api/OpenLayers.js"></script>
<script type="text/javascript">
var map, layer;
function init(){
    map = new OpenLayers.Map( 'map');
    layer = new OpenLayers.Layer.OSM( "Simple OSM Map");
    map.addLayer(layer);
    map.setCenter(
        new OpenLayers.LonLat(-1.422, 50.930).transform(
            new OpenLayers.Projection("EPSG:4326"),
            map.getProjectionObject()
        ), 12
    ); 
    
    // Add Vector marker
    var vectorLayer = new OpenLayers.Layer.Vector("Overlay");
    var feature = new OpenLayers.Feature.Vector(
     new OpenLayers.Geometry.Point(-71.147, 42.472),
     {some:'data'},
     {externalGraphic: 'img/marker.png', graphicHeight: 21, graphicWidth: 16});
    vectorLayer.addFeatures(feature);
    map.addLayer(vectorLayer);
};
init();
</script>

{% endblock %}