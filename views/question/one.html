{% extends '../layout.html' %}
{% import '../macros/_answers.html' as answers_macro %}

{% block content %}
<!-- question -->


<div class="page-header question {% if question.supportedAnswerCount === 0 and question.rejectedAnswerCount === 0 %}border-not-available{% elseif question.supportedAnswerCount > question.rejectedAnswerCount %}border-true{% else %}border-false{% endif %}">
    <div class="row">
        <div class="col-sm-5">
            <div>
                <a href="/crisis/{{ crisis.id }}" title="Crisis">
                    <i class="fa fa-fw fa-dot-circle-o"></i>{{ crisis.post.title }}
                </a>
            </div>
            <h2 class="question-title">{{ question.title }}</h2>

                <p class="lead">
                    {{ question.text }}
                </p>
                
                {% if question.targetDateTimeOccurred %}
                <p class="metadata">
                    <i class="fa fa-clock-o fa-lg fa-fw"></i>
                    <span class="sr-only">Occurred:</span>
                    <span class="">{{ question.relativeTargetDateTimeOccurred }}</span>
                    <span class="text-muted">
                        &middot;
                    {{ question.targetDateTimeOccurred|date('D, d M Y H:i:s') }}
                     <abbr title="Coordinated Universal Time" class="initialism">
                         <a href="http://en.wikipedia.org/wiki/Coordinated_Universal_Time">UTC</a>
                     </abbr>
                     </span>
                </p>
                {% endif %}


                {% if question.targetLocality or question.targetLat %}
                <p class="metadata">
                    {% if question.targetLocality %}
                    <i class="fa fa-map-marker fa-lg fa-fw"></i><span class="sr-only">Locality:</span>&nbsp;<span id="question-locality">{{ question.post.targetLocality }}</span>
                    {% endif %}
                    
                    {% if question.targetLat and question.targetLong %}
                    <i class="fa fa-crosshairs fa-lg fa-fw"></i> <span class="sr-only">Lat Long:</span> <a href="geo:{{ question.post.targetLat }},{{ question.post.targetLong }}"><span id="question-target-lat">{{ question.post.targetLat }}</span>, <span id="question-target-long">{{ question.targetLong}}</span></a>
                    {% endif %}
                </p>
                {% endif %}

                <p class="metadata">
                    <i class="fa fa-bullhorn fa-lg fa-fw"></i>
                    <span class=""><abbr title="{{ question.date.toUTCString() }}">{{ question.relativeCreatedDate }}</abbr></span>
                    by {{ question.author }}
                </p>

                {% if question.tags and question.tags.length !== 0 %}
                <p class="metadata">
                    <i class="fa fa-tag fa-lg fa-fw"></i>
                        {% for tag in question.tags %}
                            <a href="/tag/{{ tag }}"><span class="label label-primary tag">{{ tag }}</span></a>
                        {% endfor %}
                </p>
                {% endif %}
                
                <div class="action-buttons">
                    <div class="row">
                    
                        <!-- button-mark-true -->
                        <div class="action-button-ctr btn-group">
                            <button class="btn btn-success btn-large text-action-button {% if !user %} user-required-action{% endif %}" id="question-support" data-fragment="true"><i class="fa fa-check" id="icon-support"></i> <span class="sr-only">True</span></button>
                            <a href="#" class="btn btn-default action-button-count back-coloured">{{ question.supportedAnswerCount }}</a>
                        </div>
                        <!-- / button-mark-true -->
                    
                        <!-- button-mark-false -->
                        <div class="action-button-ctr btn-group">
                            <button class="btn btn-danger btn-large text-action-button {% if !user %} user-required-action{% endif %}" id="question-reject" data-fragment="false"><i class="fa fa-times" id="icon-reject"></i> <span class="sr-only">False</span></button>
                            <a href="#" class="btn btn-default action-button-count back-coloured">{{ question.rejectedAnswerCount }}</a>
                        </div>
                        <!-- / button-mark-false -->
                    
                        <!-- button-mark-important -->
                        {% set questionMarkedImportant = question.post | isMarkedImportantBy(user) %}
                        <div class="action-button-ctr btn-group">
                            <button data-crisis-id="{{ crisis.id }}"
                                    data-question-id="{{ question.id }}"
                                    class="btn btn-default btn-large text-action-button btn_markImportant
                                    {% if !user %} user-required-action{% endif %}
                                    {% if questionMarkedImportant %}disabled{% endif %}"
                                    title="Mark as important"><i class="fa fa-exclamation">
                                    </i> <span class="sr-only">Important</span>
                            </button>
                            <a href="#" class="btn btn-default action-button-count">{{ question.importanceCount }}</a>
                        </div>
                        <!-- / button-mark-important -->
                                                    
                    </div>
                
                    <!-- / action buttons row -->

                                                    
                </div>
                <!-- / action-buttons -->
                
            </div>
            
            
            <div class="col-sm-7 question-image-and-map-ctr">
                <div class="row">
                    {% if question.post.targetImage %}
                    <div class="col col-sm-6">
                        <img src="{{ question.post.targetImage }}" class="img-responsive">
                    </div>
                    <div class="col col-sm-6">
                    {% else %}
                    <div class="col col-sm-12">
                    {% endif %}
                        <div id="map" class="smallmap" style="height: 200px;"></div>
                        <!-- <img src="http://maps.googleapis.com/maps/api/staticmap?center=-15.800513,-47.91378&zoom=11&size=700x400&sensor=false" alt="map" class="img-responsive"> -->
                    </div>    
                </div>
                <!-- / .row -->
            </div>
            <!-- / .question-image-and-map-ctr -->
            
            
        </div>
        <!-- / question header row -->
        
        <!-- Twitter Tweet button -->
        <a href="https://twitter.com/share" class="twitter-share-button btn-group" data-size="large">Tweet</a>
        <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
        <!-- / Twitter Tweet button -->
                
        <!-- small buttons -->
        <div class="btn-group">
            <div class="additional-button-ctr">
                <a href="/crisis/{{ crisis.id }}/question/{{ question.id }}/edit" class="btn btn-default btn-sm"><i class="fa fa-edit"></i> <strong>Edit</strong></a>
            </div>
        </div>
        
        <div class="btn-group">
            <div class="additional-button-ctr">
                <button class="btn btn-default btn-sm" style="display: none;"><i class="fa fa-flag"></i> <strong>Flag</strong></button>
            </div>
        </div>
        <!-- / small buttons -->
        

        
        
        <!-- video -->
        {% if question.post.targetYoutubeVideoId %}
        <div class="video">
        <iframe width="323" height="200" src="//www.youtube.com/embed/{{ question.post.targetYoutubeVideoId }}?rel=0" frameborder="0" allowfullscreen></iframe>
        </div>
        {% endif %}
        <!-- / video -->
        
        
    </div>
<!-- / question -->

<!-- create evidence -->
{% include '../evidence/create.html' %}
<!-- / create evidence -->



<div class="row">
    <!-- <button class="btn btn-primary btn-large"><i class="fa fa-reply"></i> <strong>Verify</strong></button> -->
    
    
</div>

<div class="row question-answers">
    {{ answers_macro.answers_embeded(question.answers, crisis.id) }}
</div>




<script type="text/javascript">
// Support/Reject handle

// Hidden field of question type.
var questionType = document.getElementById('form-question-type');

// Display of question type
var labelQuestionType = document.getElementById('form-label-question-type');
var questionTypeClassName = labelQuestionType.className;

// Remove all children from an element
function resetElement(target) {
    while (target.firstChild) {
        labelQuestionType.removeChild(target.firstChild);
    }
}



function initActionButtons() {
    
    function displayQuestionTrueForm() {
        questionType.value = 'support';

        var supportIcon = document.createElement('i');
        supportIcon.className = 'fa fa-check';
        var content = document.createTextNode(' True because...');

        resetElement(labelQuestionType);
        labelQuestionType.insertBefore(content, labelQuestionType.nextSibling);
        labelQuestionType.insertBefore(supportIcon, content);
        labelQuestionType.className = questionTypeClassName + ' label-success';
        displayForm();
    }
    
    var update_markedImportant = function(crisis, element){
        element.next().html(crisis.importanceCount);
        element.addClass('active').addClass('disabled');
    }
    
    function displayQuestionFalseForm() {
        questionType.value = 'reject';

        var rejectIcon = document.createElement('i');
        rejectIcon.className = 'fa fa-times';
        var content = document.createTextNode(' False because...');

        resetElement(labelQuestionType);
        labelQuestionType.insertBefore(content, labelQuestionType.nextSibling);
        labelQuestionType.insertBefore(rejectIcon, content);

        labelQuestionType.className = questionTypeClassName + ' label-danger';
        displayForm();
    }
    
    if (window.location.search.indexOf('action=true') !== -1) {
        // Show the 'this is true' box.
        displayQuestionTrueForm();
    } else if (window.location.search.indexOf('action=false') !== -1) {
        // Show the 'this is false' box.
        displayQuestionFalseForm();
    }
    
    $('#question-support').click(function(){
        displayQuestionTrueForm();

    });
    $('#question-reject').click(function(){
        displayQuestionFalseForm();
    });
    
    
    
    
    $(".btn_markImportant").click(function(){
        var button = $(this);
        $.post('/crisis/'+button.attr('data-crisis-id')+'/question/'+button.attr('data-question-id')+'/markImportant',
                function(data){
                    var question = data;
                    update_markedImportant(question, button);
                }).fail(function(){
                    show_alert_message('danger', 5000, "Error", "There was an unknown error, please try again later. ");
                });
    });

}

    $(function(){
        {% if user %}
            initActionButtons();
        {% else %}
            // $('.action-button-ctr .btn').tooltip();
        {% endif %}
    });


function displayForm() {
    // Display the form.
    var formCtr = document.getElementById('form-ctr')
    formCtr.style.display = 'block';
    var formTitle = document.getElementById('form-title');
    formTitle.focus();
    
    // Update chars left
    displayCharsLeft();
    
    // Scroll the top of the form into view.
    //formCtr.scrollIntoView();
    
}



</script>
<script src="http://openlayers.org/api/OpenLayers.js"></script>
<script type="text/javascript">
var map, layer;
function init(){
    map = new OpenLayers.Map( 'map');
    layer = new OpenLayers.Layer.OSM( "Simple OSM Map");
    map.addLayer(layer);
    map.setCenter(
        new OpenLayers.LonLat(-1.422, 50.930).transform(
            new OpenLayers.Projection("EPSG:4326"),
            map.getProjectionObject()
        ), 12
    ); 
    
    // Add Vector marker
    var vectorLayer = new OpenLayers.Layer.Vector("Overlay");
    var feature = new OpenLayers.Feature.Vector(
     new OpenLayers.Geometry.Point(-71.147, 42.472),
     {some:'data'},
     {externalGraphic: 'img/marker.png', graphicHeight: 21, graphicWidth: 16});
    vectorLayer.addFeatures(feature);
    map.addLayer(vectorLayer);
};
init();
</script>

{% endblock %}