
{% macro vote_script() %}

    <script type="text/javascript">
        $(function(){
            {% if user %}
            $("div").on('click', '.btn_downvote', function(){
                var button = $(this);
                $.post('/crisis/'+button.attr('data-crisis-id')+'/question/'+button.attr('data-question-id') +'/answer/'+button.attr('data-answer-id')+'/downvote',
                        function(data){
                            var answer = data;
                            update_votes(answer, button);
                        }).fail(function(){
                            show_alert_message('danger', 5000, "Error", "There was an unknown error, please try again later. ");
                        });
            });
            $("div").on('click', '.btn_upvote', function(){
                var button = $(this);
                $.post('/crisis/'+button.attr('data-crisis-id')+'/question/'+button.attr('data-question-id') +'/answer/'+button.attr('data-answer-id')+'/upvote',
                        function(data){
                            var answer = data;
                            update_votes(answer, button);
                        }).fail(function(){
                            show_alert_message('danger', 5000, "Error", "There was an unknown error, please try again later. ");
                        });
            });

            {% endif %}
        });
        var update_votes = function(answer, element){
            element.parents('.answer-wrapper').attr('data-upvotes', answer.post.upvoteCount);
            element.parents('.answer-wrapper').attr('data-popularity', answer.popularityCoefficient);
            element.parents('.answer-buttons').find('.upvote_count').html(answer.post.upvoteCount);
            element.parents('.answer-buttons').find('.downvote_count').html(answer.post.downvoteCount);
            element.parents('.answer-buttons').find('.btn_downvote').removeClass('active').removeClass('disabled');
            element.parents('.answer-buttons').find('.btn_upvote').removeClass('active').removeClass('disabled');
            element.addClass('active').addClass('disabled');
        }
    </script>
{% endmacro %}
{% macro answers_embeded(answers, crisis_id) %}
    {% import '_generic.html' as generic_macros %}
    {{ vote_script() }}
    {% for answer in answers | reverse %}
        <div class="col-sm-4 answer-wrapper" data-date="{{ answer.post.date | date('D, d M Y H:i:s') }}" data-popularity="{{ answer.popularityCoefficient }}" data-upvotes="{{ answer.post.upvoteCount }}">
            <div class="panel panel-default question-answer">
                <div class="question-answer-bar {% if answer.type === 'support' %}label-success{% else %}label-danger{% endif %}">
                    {% if answer.type === 'support' %}
                        <span class="metric">
                            <i class="fa fa-check"></i>
                            <span class="">True because
                        </span>
                    {% else %}
                        <span class="metric">
                            <i class="fa fa-times"></i>
                            <span class="">False because
                        </span>

                    {% endif %}
                </div>
                <div class="panel-heading">
                        {% if answer.post.targetLocality %}
                            <div class="">
                               <i class="fa fa-map-marker"></i>
                               <span class="sr-only">Locality:</span>
                               <span id="answer-locality">{{ answer.post.targetLocality }}</span>
                            </div>
                        {% endif %}

                        <h3 class="panel-title">
                            <a href="/crisis/{{ crisis.id }}/question/{{ answer.question_id }}/answer/{{ answer.id }}">
                        {{ answer.post.title }}
                            </a>
                        </h3>
                </div>
                <div class="panel-body">


                    {{ answer.post.text | cropString(300)  }}
                    
                    {% if answer.post.targetImage %}
                        <div class="row">
                            <img src="{{ answer.post.targetImage }}" class="img-responsive center-block answer-image">
                        </div>
                    {% endif %}

                    {% if answer.post.targetYoutubeVideoId %}
                        <div class="video-container">
                            <iframe width="323" height="200" src="//www.youtube.com/embed/{{ answer.post.targetYoutubeVideoId }}?rel=0" frameborder="0" allowfullscreen></iframe>
                        </div>
                    {% endif %}

                    {% if answer.post.targetVideoUrl %}
                        <div id="video-wrapper-{{ answer.post.id }}" class="video-wrapper video-wrapper-ajax"
                             data-video-url="{{ answer.post.targetVideoUrl }}">
                            <div class="video-spinner"><div class="fa fa-spinner fa-spin fa-3x"></div></div>
                            <div class="video-container" style="display: none"></div>
                            <div class="video-error-message alert alert-warning" style="display: none">
                                Video link: <a target="_blank"></a>.
                            </div>
                        </div>
                    {% endif %}
                    
                        <div class="">
                            <i class="fa fa-bullhorn"></i>
                            <span class=""><abbr title="{{ answer.post.date.toUTCString() }}">{{ answer.post.date | relativeTime }}</abbr></span>
                            by {{ answer.post.user.name }}
                        </div>

                    <!-- vote row -->
                    <div class="row">
                        {{ evidence_actions(crisis_id, answer.question_id, answer) }}
                    </div>
                    <!-- / vote row -->

                </div>
            </div>
        </div>
    {% endfor %}
    {{ generic_macros.video_html_script() }}
{% endmacro %}
{% macro evidence_actions(crisis_id, question_id, answer) %}
<div class="answer-buttons">

    <!-- button-vote-up -->
    <div class="mini action-button-ctr btn-group">
        {% set answer_upvoted = answer | isUpvotedBy(user) %}
        <button data-crisis-id="{{ crisis_id }}" data-question-id="{{ question_id }}" data-answer-id="{{ answer.id }}" class="btn btn-default btn-large mini-action-button btn_upvote {% if !user %} user-required-action{% endif %} {% if answer_upvoted %}disabled{% endif %}"  title="Upvote"><i class="fa fa-arrow-up"></i></button>
        <a href="#" class="btn btn-default action-button-count upvote_count">{{ answer.post.upvoteCount }}</a>
    </div>
    <!-- / button-vote-up -->

    <!-- button-vote-down -->
    <div class="mini action-button-ctr btn-group">
        {% set answer_downvoted = answer | isDownvotedBy(user) %}
        <button data-crisis-id="{{ crisis_id }}" data-question-id="{{ question_id }}" data-answer-id="{{ answer.id }}" class="btn btn-default btn-large mini-action-button btn_downvote {% if !user %} user-required-action{% endif %} {% if answer_downvoted %}disabled{% endif %}" title="Downvote"><i class="fa fa-arrow-down"></i></button>
        <a href="#" class="btn btn-default action-button-count downvote_count answer_number_{{ answer.id }}">{{ answer.post.downvoteCount }}</a>
    </div>
    <!-- / button-vote-down -->

    <!-- button-comment -->
    <div class="mini action-button-ctr btn-group">
        <button data-crisis-id="{{ crisis_id }}" data-question-id="{{ question_id }}" data-answer-id="{{ answer.id }}" data-fragment="comment" class="btn btn-default btn-large mini-action-button btn_comment {% if !user %} user-required-action{% endif %}" title="Comment"><i class="fa fa-comment"></i></button>
        <a href="#" class="btn btn-default action-button-count">{{ answer.comments | length }}</a>
    </div>
    <!-- / button-comment -->
</div>
{% endmacro %}
