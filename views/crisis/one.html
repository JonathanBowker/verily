{% extends '../layout.html' %}
{% import '../macros/_generic.html' as generic_macro %}

{% set path = "/crisis/" + crisis.id %}

{% block breadcrumb %}
    <li>
        <a href="/" title="Home">Home</a>
    </li>
    <li>
        {{ crisis.post.title }}
    </li>
{% endblock %}
{% block content %}

<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_GB/sdk.js#xfbml=1&appId=1430472757228218&version=v2.0";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>

<div class="page-header">
    <div class="row">
        <div class="col-sm-8">
            <h2 class="question-title">
                {{ crisis.post.title }}
            </h2>

            <p class="lead">
                {{ crisis.post.text }}
            </p>

            <div class="action-buttons">
                {% if userCan('create a question') %}
                <div class="action-button-ctr btn-group">
                    <a class="btn btn-primary crisis-ask-question" href="/crisis/{{ crisis.id }}/question/create">Make Verification Request</a>
                </div>
                {% endif %}

                {#
                <!-- button-mark-important (Commented for the challenge) -->
                <!-- <div class="action-button-ctr btn-group">
                    {% set crisis_markedImportant = crisis.post | isMarkedImportantBy(user) %}
                    <button data-crisis-id="{{ crisis.id }}"
                            data-question-id="{{ answer.question_id }}"
                            data-answer-id="{{ answer.id }}"
                            class="mark-important-crisis-btn btn btn-default btn-large text-action-button {% if !properUser %} user-required-action{% endif %} {% if crisis_markedImportant %}disabled{% endif %}"
                            title="Mark as important">
                                <i class="fa fa-star"></i>
                                Important</a>
                    </button>
                    <a href="#" class="btn btn-default action-button-count disabled">{{ crisis.importanceCount }}</a>
                </div> -->
                <!-- / button-mark-important -->
                #}

            </div>
            <!-- / action-buttons -->
                

                
            </div>
            
            
            <div class="col-sm-7 question-image-and-map-ctr">
                <div class="row">
                    {% if crisis.post.targetImage %}
                    <div class="col col-sm-6">
                        <img src="{{ crisis.post.targetImage }}" class="img-responsive">
                    </div>
                    <div class="col col-sm-6">
                    {% else %}
                    <div class="col col-sm-12">
                    {% endif %}
                        <!-- <div id="map" class="smallmap" style="height: 200px;"></div> -->
                    </div>
                </div>
                <!-- / .row -->
            </div>
            <!-- / .question-image-and-map-ctr -->
            
            
        </div>
        <!-- / question header row -->
        

                
        <!-- small buttons -->
		{% if userCan('edit a crisis') %}
			<div class="btn-group">
				<div class="additional-button-ctr">
					<a href="/crisis/{{ crisis.id }}/edit" class="btn btn-default btn-sm"><i class="fa fa-edit"></i> <strong>Edit</strong></a>
				</div>
			</div>
		{% endif %}
        
        <div class="btn-group">
            <div class="additional-button-ctr">
                <button class="btn btn-default btn-sm" style="display: none;"><i class="fa fa-flag"></i> <strong>Flag</strong></button>
            </div>
        </div>
        <!-- / small buttons -->
        

        
                
        
    </div>
    
</div>
<!-- / .page-header -->






<div class="row crisis-questions-header">
    <div class="col-sm-9">
        Ask your social network to help with these questions
        <!-- temporal buttons for testing!-->
        <div class="sharing-buttons question">
            <!-- button-email -->
            <div class="action-button-ctr btn-group">
                <a class="btn btn-default btn-large text-action-button" id="button-share-question-email" href="mailto:?subject={{ questionTitleForSharing }}"><i class="fa fa-envelope-o"></i> <span class="hidden-xs">Email</span></a>
            </div>
            <script>
                var buttonShareQuestionEmail = document.getElementById('button-share-question-email');
                var emailMessage = common.campaigner('email', '{{ questionTitleForSharing }}', refUrlEmail);
                buttonShareQuestionEmail.href = 'mailto:?subject=' + emailMessage.subject + '&body=' + emailMessage.body;
            </script>
            <!-- / button-email -->

            <!-- button-share-question-link -->
            <div class="action-button-ctr btn-group">
                <a class="btn btn-default btn-large text-action-button" id="button-share-question-link" data-toggle="modal" data-target="#modal-share-question-link"><i class="fa fa-link"></i> <span class="hidden-xs">Link</span></a>
            </div>
            <!-- / button-share-question-link -->

            <!-- Facebook Share button -->
            <div class="action-button-ctr btn-group">
                <a class="btn btn-default btn-large text-action-button share-button facebook-blue" id="facebook-share-button"><i class="fa fa-facebook-square fa-lg facebook-blue"></i> Share</a>
            </div>
            <!-- / Facebook Share button -->

            <!-- Twitter Tweet button -->
            <a href="https://twitter.com/share" class="twitter-share-button btn-group" id="tweet-button" data-url data-size="large">Tweet</a>
            <!-- / Twitter Tweet button -->




            <!-- small buttons -->
            <br/>
            {% if userCan('edit a question') %}
                <div class="btn-group">
                    <div class="additional-button-ctr">
                        <a href="/crisis/{{ crisis.id }}/question/{{ question.id }}/edit" class="btn btn-default btn-sm"><i class="fa fa-edit"></i> <strong>Edit</strong></a>
                    </div>
                </div>
            {% endif %}

        </div>

        <div class="btn-group">
            <div class="additional-button-ctr">
                <button class="btn btn-default btn-sm" style="display: none;"><i class="fa fa-flag"></i> <strong>Flag</strong></button>
            </div>
        </div>
        
    </div>
    
    <div class="col-sm-3 text-right">
        <label for="select_filter_questions">Order by</label>
        <select id="select_filter_questions">
            <option value="Recent">Time</option>
            <option value="Popular">Popularity</option>
        </select>

    </div>
    
</div>

<div class="crisis-questions display-table">
    {% for question in questions | reverse %}
        {% set numColumns = 3 %}
        {% set colWidth = 12 / numColumns %}
        {% if loop.index % numColumns == 1 %}
            <div class="row">
        {% endif %}
        <div class="col-sm-{{ colWidth }} crisis-question-wrapper" data-date="{{ question.post.date | date('D, d M Y H:i:s') }}" data-popularity="{{ question.popularityCoefficient }}">
            <div data-href="{{ question.canonicalPath }}" style="cursor:pointer"
                 class="panel panel-default verily-panel crisis-question-border {% if question.supportedAnswerCount === 0 and question.rejectedAnswerCount === 0 %}border-not-available{% elseif question.supportedAnswerCount > question.rejectedAnswerCount %}border-true{% else %}border-false{% endif %}">
                <div class="panel-heading">
                        {% if question.post.targetLocality %}
                            <div class="">
                               <i class="fa fa-map-marker"></i>
                               <span class="sr-only">Locality:</span>
                               <span id="question-locality">{{ question.post.targetLocality }}</span>
                            </div>
                        {% endif %}

                    <h3 class="panel-title" >
                        <a href="{{ question.canonicalPath }}">
                            {{ question.post.title }}
                        </a>
                    </h3>
                    <div class="clearfix">
                        <div class="crisis-question-metrics pull-left">
                            {#
                            <!-- Comment for Challenge!
                            <span class="label metric crisis-question-metric important success" title="Marked as important"><i class="fa fa-star"></i> {{ question.importanceCount }}</span>
                            -->
                            #}
                            <span class="label metric crisis-question-metric" title="Answers that state this is true"><i class="fa fa-check success"></i> <span class="success">{{ question.supportedAnswerCount }}</span></span>

                            <span class="label metric crisis-question-metric danger" title="Answers that state this is false"><i class="fa fa-times danger"></i> <span class="danger">{{ question.rejectedAnswerCount }}</span></span>
                        </div>
                        <a style="font-size:.8em" title="help answer this question" class="btn btn-sm btn-default pull-right" href="{{ question.canonicalPath }}">
                            Answer this
                        </a>
                    </div>
                </div>
                <div class="panel-body">
                    {% if question.post.targetVideoUrl %}
                        <div id="video-wrapper-{{ question.post.id }}" class="video-wrapper video-wrapper-ajax"
                             data-video-url="{{ question.post.targetVideoUrl }}">
                            <div class="video-spinner"><div class="fa fa-spinner fa-spin fa-3x"></div></div>
                            <div class="video-container" style="display: none"></div>
                            <div class="video-error-message alert alert-warning" style="display: none">
                                Video link: <a href="{{ question.post.targetVideoUrl }}" class="video-error-message" target="_blank">{{ question.post.targetVideoUrl }}</a>.
                            </div>
                        </div>
                    {% elseif question.post.targetImage %}
                        <div class="row question-image" style="background-image: url({{ question.post.targetImage }});">
                        </div>
                    {% endif %}
                    <div class="posted">
                        Posted
                        <span class=""><abbr title="{{ question.date.toUTCString() }}">{{ question.relativeCreatedDate }}</abbr> ago </span>
                        by {{ question.post.author }}
                    </div>
                </div>

            </div>
        </div>
            {% if loop.index % numColumns == 0 %}
        </div>
        {% endif %}
        <!-- / .col-sm-4 -->
    {% endfor %}
</div>

{{ generic_macro.video_html_script() }}
{{ generic_macro.rearrange_children_script() }}

{#
<script src="/static/js/openlayers/OpenLayers-https.js"></script>
    <script src="/static/js/maps.js"></script>
#}
<script type="text/javascript">
var map, layer;

map = map_init('map');
    $(function(){
        var cntrlIsPressed = false;
        $(document).keydown(function(event){
            if(event.which=="17")
                cntrlIsPressed = true;
        });

        $(document).keyup(function(){
            cntrlIsPressed = false;
        });
        $('.verily-panel').click(function(e){
            if(!cntrlIsPressed && e.which !== 2) {
                // Not middle click.
                location.href=$(this).data('href');
            }
        });
        $(".mark-important-crisis-btn").click(function(){
            var button = $(this);
            $.post('/crisis/'+button.attr('data-crisis-id')+'/markImportant',
                    {_csrf: "{{csrf_token}}" },
                    function(data){
                        var crisis = data;
                        update_markedImportant(crisis, button);
                    }).fail(function(){
                        show_alert_message('danger', 5000, "Error", "There was an unknown error, please try again later. ");
                    });
        });
        $('#select_filter_questions').change(function(){
            if($('#select_filter_questions').val() == "Recent"){
                rearrange_children($('.crisis-questions'), function(a,b){
                    return new Date($(b).data('date')) - new Date($(a).data('date'));
                });

            }
            else if($('#select_filter_questions').val() == "Popular"){
                rearrange_children($('.crisis-questions'), function(a,b){
                    return $(b).data('popularity') - $(a).data('popularity') ;
                });

            }

        });
        if($('#select_filter_questions').prop("selectedIndex") != 0){
            //trigger change if the initial selected index is not 0
            $('#select_filter_questions').change();
        }
        {% if crisis.post.targetLat and crisis.post.targetLong %}
        if(map_add_marker) map_add_marker(map,{{ crisis.post.targetLat }}, {{ crisis.post.targetLong }} );
        {% endif %}

    });

    var update_markedImportant = function(crisis, element){
        element.next('a.action-button-count').text(crisis.importanceCount);
        element.addClass('active').addClass('disabled');
    }
</script>

<script type="text/javascript">
var facebookShareButton = document.getElementById('facebook-share-button');
facebookShareButton.addEventListener('click', function(e) {
    FB.ui({
      method: 'share',
      href: 'https://veri.ly{{path}}',
    }, function(response){
        
    });
});
window.twttr = (function (d, s, id) {
    var t, js, fjs = d.getElementsByTagName(s)[0];
    if (d.getElementById(id)) return;
    js = d.createElement(s); js.id = id; js.src= "https://platform.twitter.com/widgets.js";
    fjs.parentNode.insertBefore(js, fjs);
    return window.twttr || (t = { _e: [], ready: function (f) { t._e.push(f) } });
}(document, "script", "twitter-wjs"));
</script>

{% endblock %}